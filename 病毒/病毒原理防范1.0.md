PE病毒，引导病毒，蠕虫病毒 、木马病毒   四种病毒

## 第一章：考试PPT

**病毒的概念 什么是病毒 计算机病毒**

计算机病毒是计算机程序中被嵌入的一组破坏计算机功能或毁坏数据的计算机指令或者程序代码

**计算机病毒的特征（五六个）**

隐蔽性
潜伏性
破坏性
不可预见性

**病毒生命周期（四个阶段）  **

传染阶段：
潜伏阶段：
触发阶段：
发作阶段：表现/破坏

**病毒对抗的技术（几种对抗的技术有什么特点 特征的原理（书上和PPT上）） **

特征码扫描
	缺点：不能检测病毒变种或新型病毒；
		  特征库越来越大。

启发式扫描
	缺点：检测结果不准确
               无法准确辨认病毒的名称和类别

虚拟机技术 
     缺点：占用较多的系统资源，影响系统性能
                要很难准确辨认病毒类别
                开发投入较多

主动防御技术 
	实时监控程序系统调用来确定其行为

自免疫技术
   自校验和审计

**杀毒软件有几种类型 （例如启发式）**

 1、未知病毒查杀技术

2、防病毒立体化体系

3、流扫描技术

4、云安全

## 第二章：

PE文件解析 PE数据结构 头部 DOS PE头 文件头（20个字节） 可选头(imagebase oep 内存对齐粒度 文件对齐粒度 数据目录（导入导出表）)  节表 某一节的数据 以及几个重要的字段

![image-20250101105926910](%E7%97%85%E6%AF%92%E5%8E%9F%E7%90%86%E9%98%B2%E8%8C%831.0.assets/image-20250101105926910.png)

文件型病毒

解析      感染

（静态方法）调用时，根据函数名查引入表，就可以获取该函数的地址

（动态方法）获取API函数的地址用了两个windows的API 一个loadlibrary getaddress   它们均在kernel32.dll当中 

因为 LoadLibrary 和 GetProcAddress 是 kernel32.dll 提供的系统函数，必然在其引出表中被导出，所以获取 kernel32 的地址后就可以通过搜索其引出表来得到这两个函数的地址，找kernel32.dll有四种方法：

1、根据系统函数返回地址；

2、通过宿主进程的PEB:进程环境块获得

3、

**病毒感染的方式**：三种方式（考察步骤、复现，如何操作、具体流程）

1、插入一个新的节（准备一堆数据，当中代码插入在最末尾一个，为了描述这一堆数据，需要插入一个新的节表（需要大致描述节表中的信息），节的数目就加一，文件头的内容可能发生变化，文件大小发生变化（前面有一个字段描述的需要改动））

![image-20250101121218757](E:\算法学习\病毒原理防范1.0.assets\image-20250101121218757.png)

2、新增一个节：

先把病毒代码追加到文件尾部，在节表中增加一个section header各项数据填写正确(VirtualSize,VirtualAddress,PointerToRawData.....

在FILEHEADER中修改节表项数目:+1。
重新计算SizeofHeaders，并替换原值。
重新计算Sizeoflmage，并替换原值。

3、扩展一个节

**（病毒编写的难点克服方法）写了一堆数据，需要丢到其他环境来正确执行的方法**：（文件型病毒PPT 12-25页）

1、重定位

2、获取API函数的地址

本PPT的52页以后好好看一下

导入表：引用别人的模块

双向结构：两根线中，上面一根线（original first thunk）是一个指针 

下面的线叫做name first thunk也是一个指针 

上面一个指针指向INT表  下面指向IAT表 

IAT表在PE文件加载内存前后是要发生变化的



## 第三章

**引导性病毒**

专门感染磁盘引导扇区和硬盘主引导扇区的计算机病毒程序

INT 13H磁盘I/O中断熟练掌握  ：调中断对磁盘进行读写（操作读写磁盘）、

主引导扇区是我们磁盘上面的第一个扇区   0柱面 0磁道  1扇区

**扇区由三大部分组成**：

MBR、DPT、引导扇区标识

MBR:一堆代码 知道是做什么的

DPT（64字节）：四个分区表项 每一个分区表项十六个字节  112 112 4 4 熟练掌握每一个字段的含义

**实模式底项的1MB内存组成大概分成哪几个段（**大概是三大部分）：

1、物理内存条  640KB  偏移0413的两个字节处（12分8秒处）

2、显卡、外部设备

3、bus 实模式

**引导型病毒用的两个技术**：（理解）

1、**常驻内存高端**：

想办法把病毒程序载入到内存中，载入后保证这一段代码不被其他代码覆盖。
内存0000:0413处两字节描述了基本内存的大小，它的值是KB的倍数。

2、**修改向量表中断,截获系统中断** 

**整个系统引导的过程**（掌握 大纲PPT上有）



## 第四章

网络蠕虫：

**一 调用约定**：

1、cdedel

```
1）参数首先由右向左压入堆栈

2）函数本身不清理堆栈，调用者负责清理堆栈
```



2、stdcall

```
  1）参数从右向左压入堆栈；

  2）函数自身修改堆栈；自身清理堆栈

  3) 函数名自动加前导的下划线，后面紧跟一个@符号，其后紧跟着参数的尺寸。
  
  mov   ebp,esp           保存堆栈指针

  mov   eax,[ebp + 8H]    堆栈中ebp指向位置之前依次保存有ebp,cs:eip,a,b,ebp +8指向a

  add   eax,[ebp + 0CH]   堆栈中ebp + 12处保存了b

  mov   esp,ebp           恢复esp

  pop   ebp

  ret   8
```

掌握方式：

1、传参方式 ；使用堆栈传参

2、传参顺序 ；从右到左

3、堆栈的销毁：

**二 缓冲区溢出的原理**：

配合堆栈：（原理）局部变量赋值超出了它的界限，它不断从低地址向高地址方向赋值，覆盖返回地址，就造成了缓冲区溢出了

原因：1、使用了不安全的函数；2、关闭了系统保护

payload由三个部分组成：

1、填充区域，内容不重要，长度很关键

2、找一条jmp ESP的地址，把它写到返回地址处

3、shellcode

**简单的payload要会写**

**什么是shellcode，它的特点**：

Shellcode是指能完成特殊任务的自包含的二进制代码，根据不同的任务可能是发出一条系统调用或建立一个高权限的Shell,  Shellcode因此得名。
最终目的：获取目标机器的控制权

特点：

Shellcode一般是作为数据形式发送给服务器，制造溢出得以执行代码并获取控制权的
（1）长度受限
（2）不能使用特殊字符，例如\x00、\xff等
（3）具有重定位能力
（4）一定的兼容性

**文件型病毒和蠕虫型病毒的区别和联系（PPT第四章第八页）**

![image-20250101111709379](%E7%97%85%E6%AF%92%E5%8E%9F%E7%90%86%E9%98%B2%E8%8C%831.0.assets/image-20250101111709379.png)

## 第五章

**木马：偏概念性的较多**

**由三个部分组成（每个部分是什么）**

木马配置程序、控制端程序、被控端程序

**木马病毒入侵的基本过程：（分成哪几个基本阶段）**（配传运信建远）

1、配置木马；2、传播木马；3、运行木马；4、信息反馈；5、建立连接；6、远程控制

**木马常用的通信协议有哪些**

1、利用TCP、UDP传输数据； 2、利用ICMP、HTTP协议建立秘密通道

**写一个木马常用哪些技术**

**木马的隐藏技术：**

通常有三种：通信隐藏、服务隐藏、进程隐藏

伪隐藏与真隐藏

真隐藏：DLL木马  DLL劫持 动态嵌入DLL木马

**木马的秘密信道技术：**

1、利用TCP、UDP传输数据

2、利用ICMP协议建立秘密通道

3、利用HTTP协议建立秘密通道

**远程控制的控制技术：**（屏键鼠进系）

屏幕的截取
键盘操作
鼠标操作
进程管理
系统管理和文件操作

**木马常用的自启动方式**

1、捆绑应用程序,dll劫持；

2、修改系统注册表的各种启动项（常用）；

3、注册为一个系统服务；

4、应用程序启动组；

5、修改文件关联

**木马传播的方式**

1、以邮件附件的形式传播
2、通过MSN、QQ等聊天工具软件传播
3、通过共享软件网站(Web/FTP/BBS)传播
4、通过一般的病毒和蠕虫传播
5、通过磁盘和光盘进行传播



**实验部分很重要 ：写代码的部分（理解）**

试卷中的知识点：

选择题：

1、节表中表示节的名称的数组长度**是8字节**

2、在D0S MZ头中偏移**3CH**字节处的值指示了PE文件头

3、

```
20H  包含代码
40H  包含已初始化的数据
60H  包含未初始化的数据
2000000H 可执行
4000000H 可读
6000000H 可写
```

4、数据目录DataDirectory中每个表项（结构体）占的字节是**8字节**

5、木马隐藏技术



1. **ImageBase（基址）的概念和 VA（虚拟地址）含义**
   - **ImageBase**：在 PE（Portable Executable）文件格式中，ImageBase 是一个重要的概念。它是指程序（可执行文件或动态链接库）在内存中的首选加载基地址。当程序被加载到内存时，操作系统会尽量将程序加载到这个指定的基地址上。例如，对于大多数 32 位的 Windows 可执行文件，ImageBase 通常是 0x00400000。
   - **VA（虚拟地址）**：虚拟地址是程序在内存中访问数据或代码时使用的地址。对于 PE 文件，一个内存位置的虚拟地址是相对于 ImageBase 来计算的。例如，如果一个函数的 RVA（相对虚拟地址）是 0x1000，而 ImageBase 是 0x00400000，那么这个函数在内存中的虚拟地址（VA）就是 0x00401000（计算方式为 ImageBase + RVA）。
2. **入口点（Entry Point）的概念和 RVA（相对虚拟地址）含义**
   - **入口点**：入口点是程序开始执行的位置。当一个可执行文件被加载并运行时，操作系统会将控制权交给程序的入口点。对于 PE 文件，入口点通常是一个函数的地址，这个函数包含了程序启动后要执行的第一条指令。
   - **RVA（相对虚拟地址）**：相对虚拟地址是相对于模块（可执行文件或动态链接库）基地址（ImageBase）的偏移量。对于入口点来说，入口点的 RVA 表示入口点相对于 ImageBase 的偏移。这样的设计方便了程序在内存中的加载和重定位。例如，如果一个 PE 文件被加载到一个与指定 ImageBase 不同的地址，通过入口点的 RVA 可以很容易地找到实际的入口点位置，然后开始执行程序。